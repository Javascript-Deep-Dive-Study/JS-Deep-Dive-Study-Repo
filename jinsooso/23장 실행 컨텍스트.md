# 자바스크립트 딥다이브 23장 실행 컨텍스트

## 실행 컨텍스트란?

***

- 자바스크립트의 동작원리를 담고 있는 개념

  > 소스코드를 실행하는 데 필요한 환경을 제공하고 코드의 실행 결과를 실제로 관리하는 영역을 의미
  >
  > 모든 코드는 실행 컨텍스트를 통해 실행되고 관리된다.

실행 컨텍스트를 이해하기 위해서는 코드 실행을 이해할 수 있어야 한다.

- 식별자를 스코프로 구분해 등록하고, 상태 변화를 관리할 수 있어야 한다.

  > - 식별자는 코드 내의 변수, 함수, 혹은 속성을 식별하는 문자열을 의미한다.
  >
  > - 스코프는 현 재 실행되는 컨텍스트( 값과 표현식이 "표현"되거나 참조 될 수 있음을 의미 )를 의미한다.
  >   - 함수 내에서 정의된 변수는 그 함수의 전체에 걸쳐서 유효하다.
  > - 상태 관리란 각 컴포넌트가 보유하는 상태(데이터)를 변화 / 관리 하는 것을 의미한다.

- 스코프 체인을 통해 상위 스코프로 이동하면서 식별자를 검색할 수 있어야 한다.

  > - 스코프 체인은 해당 코드의 유효 범위(In scope) 안에 있는 변수를 정의하는 객체의 체인, 리스트다..?
  > - 자바스크립트 엔진이 식별자를 찾을 때, 자신이 속한 스코프에서 찾고 식별자가 없으면 상위 스코프로 찾아 나선다.
  > - 이를 스코프 체인이라고 한다. 이는 스코프가 중첩되어있는 모든 상황에서 발생한다고 한다.

- 실행 중인 코드 실행 순서를 변경할 수 있어야 하며 다시 되돌아 갈 수도 있어야 한다.

이처럼 코드를 실행하기 위해서는 위 스코프, 식별자, 코드 실행 순서를 관리해야 한다. 이를 위해 실행 컨텍스트가 존재한다.



## 소스코드 유형

***

- ECMA스크립트는 4가지 타입으로 소스코드를 구분했다.
- 해당 타입들의 소스코드는  실행 컨텍스트를 생성한다. 각 타입에 따라 실행 컨텍스트가 생성과정 / 관리 내용이 다르다.



#### 전역 코드 (global code)

- 전역에 존재하는 소스코드다. 전역 함수와 클래스 등의 내부 코드는 포함되지 않는다

  > 전역 함수는 모든 전역 변수와 전역 함수에 접근 할 수 있다. 

- 전역 변수를 관리하기 위해 전역 스코프를 생성한다



#### 함수 코드 (function code)

- 함수 내부에 존재하는 소스코드이다. 함수 내부에 중첩된 함수나 클래스 등의 내부 코드는 포함되지 않는다.

  > 클래스는 객체를 생성하기 위한 템플릿이다. 데이터와 이를 조작하는 코드를 하나로 추상화한다.
  >
  > 객체 지향 프로그래밍에서 사용되는 다양한 기능을 자바스크립트에서도 사용할 수 있도록 한다.

- 함수 코드는 지역 스코프를 생성하고, 매개변수, arguments 객체를 관리한다.

  > arguments 객체는 함수에 전달된 인수에 해당되는 Array 형태의 객체이다.
  >
  > "Array 형태 / 유사배열"이란 '.length' 속성과 인덱스 된 다른 속성을 가지고 있지만 forEach, map과 같은 내장 메서드는 가지고 있지 않다.
  >
  > arguments 객체를 사용하는 이유는 함수에 제공된 매개변수의 수를 제한하지 않고 모두 적용되는 매개변수를 모은 객체를 만들고 싶을 때, 사용가능 하다.



#### Eval 코드

- 빌트인 전역 함수인 eval함수에 인수로 전달되어 실행되는 소스코드를 의미

- eval 코드는 strict mode에서 자신만의 독자적인 스코프를 생성한다.

  > Eval() 함수는 과거에 사용된 것 같습니다. 강제적으로 속성에 접근하거나 실행을 강요하는 기능이 있다. 하지만 현재는 사용되지 않으며 보안상의 위험이 있어 사용을 금지하고 있다.



#### 모듈 코드

- 모듈 내부에 존재하는 소스코드를 말한다. 하지만 모듈 내부의 함수나 클래스 등의 내부 코드는 포함되지 않는다.
- 모듈 별로 독립적이 모듈 스코프를 생성한다.



## 소스코드의 평가와 실행

***

모든 소스코드는 평가하는 과정을 거쳐 코드를 실행한다. 즉, 자바스크립트 엔진은 소스코드를 `소스코드의 평가` 와 `소스코드의 실행` 과정으로 나누어 처리한다.

- 소스코드의 평가 과정에서는 실행에 필요한 변수 / 함수의 참조 정보를 실행 컨텍스트가 관리하는 스코프에서 검색 / 취득한다.

- 변수 값 변경 등의 실행 결과는 다시 실행 컨텍스트가 관리하는 스코프에 등록된다.



## 실행 컨텍스트 스택

***

생성된 실행 컨텍스트는 스택 자료구조로 관리된다. 이를 실행 컨텍스트 스택이라고 한다.

실행 컨텍스트 스택은 코드 실행 순서를 관리한다.

![image-20210829192538701](/Users/admin/Library/Application Support/typora-user-images/image-20210829192538701.png)

이처럼 실행된 코드들은 위와 같이 실행 컨텍스트가 추가되고 실행되면서 제거된다.

> 소스코드가 평가되면 실행 컨텍스트가 생성되고 실행 컨텍스트 스택의 최상위에 쌓인다. 실행 컨텍스트 스택의 최상위에 존재하는 실행 컨텍스트는 언제나 현재 실행중인 코드의 실행 컨텍스트이다.



## 렉시컬 환경

***

렉시컬 환경(Lexical Environment)은 식별자와 식별자에 바인딩된 값, 그리고 상위 스코프에 대한 참조를 기록하는 자료구조로, 실행 컨텍스트를 구성하는 컴포넌트를 말한다. 렉시컬 환경은 키와 값을 갖는 객체 형태의 스코프를 생성해 식별자를 키로 등록하고 식별자에 바인딩된 값을 관리한다.

실행 컨텍스트 스택이 코드의 실행 순서를 관리한다면, **렉시컬 환경은 스코프와 식별자를 관리한다.**

렉시컬 환경은 두개의 컴포넌트로 구성된다.



#### 환경 레코드 (Environment Record)
스코프에 포함된 식별자를 등록하고 등록된 식별자에 바인딩된 값을 관리한다.



#### 외부 렉시컬 환경에 대한 참조 (Outer Lexical Environment Reference)
상위 스코프를 가리킨다. 상위 스코프는 상위 코드의 렉시컬 환경을 말한다. 외부 렉시컬 환경에 대한 참조를 통해 단방향 링크드 리스트인 스코프 체인을 구현한다.



#### 전역 환경 레코드 생성 (var,let,const)

>전역 렉시컬 환경을 구성하는 컴포넌트인 `전역 환경 레코드`는 `var` 키워드와 `let`, `const` 키워드로 선언한 전역 변수를 구분하기 위해 **객체 환경 레코드 (Object Environment Record)** 와 **선언적 환경 레코드 (Declarative Environment Record)** 로 구성되어 있다.
>
>전역 환경 레코드의 `객체 환경 레코드`를 통해 위 예제의 전역 변수 `x`와 전역 함수 `foo`는 전역 객체(window)의 프로퍼티와 메서드가 된다.
>
>const로 선언한 변수 `y`는 전역 환경 레코드의 `선언적 환경 레코드` 에 등록되고 관리된다. 
>
>이처럼 전역 변수 `y`는 전역 객체의 프로퍼티가 되지 않기 때문에, `window.y`와 같이 전역 객체의 프로퍼티로서 참조할 수 없다.
>
>전역 환경 레코드에는 `this`가 바인딩된다. 전역 코드에서 `this`는 전역 객체를 가리키므로 전역 환경 레코드의 `this`에는 전역 객체가 바인딩된다.





